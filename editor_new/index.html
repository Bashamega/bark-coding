<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bark Blockly Editor</title>
    <link rel="shortcut icon" href="https://bark-coding.vercel.app/favicon.ico">
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://bark-coding.vercel.app/editor_new/p5.min.js"></script>
    <script src="https://bark-coding.vercel.app/editor_new/sketch.js"></script>
    
    <script src="custom_category_es6.js"></script>
    <script src="toolbox_label_es6.js"></script>
    <link rel="stylesheet" lang="css" href="https://bark-coding.vercel.app/src/themes/bluedodger.css">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Montserrat);
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      body {
        background-color: #fff;
      }

      .navbar {
        overflow: hidden;
        height: 45px;
      }

      .tabpage {
        display: none;
        height: calc(100% - 80px);
        width: calc(100% - 480px);
        position: absolute;
        bottom: 0;
      }

      body.code #blocklyDiv {
        display: block;
      }

      body.costumes #costumeseditordiv {
        display: block;
      }

      body.sounds #soundseditordiv {
        display: block;
      }

      #blocklyDiv * {
        transition: 0s;
      }

      #stage {
        height: 360px;
        width: 480px;
        border: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        border-radius: 5px;
        position: absolute;
        right: 0px;
        transition: 0s;
        background-color: #ffffff;
      }

      .stage-left #stage {
        left: 0px;
      }

      #generated-code {
        height: calc(100% - 40px); /* Adjusted height to accommodate navbar */
        width: 25%;
        background-color: #f4f4f4;
        padding: 10px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
        display: block; /* Initially visible */
      }
      
      .hidden {
        display: none; /* Hide the generated code area */
      }

      .blocklyToolboxDiv {
        padding: 0px;
        overflow-y: hidden;
      }

      .blocklyToolboxDiv[layout="v"] .blocklyToolboxCategory {
        height: inherit;
        cursor: pointer;
        margin: 0px;
      }

      .blocklyTreeLabel {
        font: 13px "Montserrat";
        color: #fff;
        padding: 11px;
      }

      .blocklyTreeRowContentContainer img {
        display: none;
      }

      .stage-left #blocklyDiv {
        position: absolute;
        right: 0px;
      }

      .dark-mode * .blocklySvg {
        background-color: #181818;
      }

      #editortabs {
        position: absolute;
        height: 35px;
      }
      
      #editortabs button {
        font-family: inherit;
        background-color: inherit;
        color: inherit;
        border: none;
        height: 15px;
        font-size: 15px;
        padding: 10px;
        cursor: pointer;
      }
    </style>
  </head>

  <body onload="start()" class="code">
    <div class="navbar">
      <a href="https://bark-coding.vercel.app/index.html"><img src="https://bark-coding.vercel.app/src/images/Logo.svg" alt="Bark" width="25" height="25"></a>
      <a href="#">save</a>
      <a href="#" id="downloadbutton" onclick="downloadproject();" title="download project to your computer.">download</a>
      <a href="#" title="watch helpful tutorials to expand your knowledge!">tutorials</a>
      <a href="#" onclick="alert('you can\'t publish projects yet! :(');" title="publish your project so the world can see!">publish</a>
      <a class="dark-mode-button" id="darkModeToggle"><dmbico alt="Dark Mode"></dmbico></a>
      <a class="right" href="https://bark-coding.vercel.app/login.html">sign in</a>
      <a class="right" href="https://bark-coding.vercel.app/signup.html">join bark</a>
    </div>
    <div id="blocklyDiv" class="tabpage"></div>
    <div id="costumeseditordiv" class="tabpage">
      <h1>Upload costume</h1>
      <input type='file' accept='image/*' onchange='openFile(event)'><br>
      <img id='costume' style="width:70px;" src="https://bark-coding.vercel.app/static/stickman.svg">
      <br/>
      <input type="text" value="Costume - 1" placeholder="costume name">
    </div>
    <div id="soundseditordiv" class="tabpage">
      <h1>Upload sound</h1>
      <form><input type="file" accept=".mp3,.wav"><input type="submit"></form>
      <p>Work in Progress!</p>
    </div>
    <div id="editortabs">
      <button onclick="document.body.classList.add('code'); document.body.classList.remove('costumes'); document.body.classList.remove('sounds');">Code</button>
      <button onclick="document.body.classList.remove('code'); document.body.classList.add('costumes'); document.body.classList.remove('sounds');">Costumes</button>
      <button onclick="document.body.classList.remove('code'); document.body.classList.remove('costumes'); document.body.classList.add('sounds');">Sound</button>
    </div>
    <div id="projectPlayer">
        <div id="projectToolbar">
          <img class="projectToolbarButton" style="cursor:pointer;" src="https://bark-coding.vercel.app/src/projecttoolbar/run.svg" width="10" onclick="run_code();">
          <img class="projectToolbarButton" style="cursor:pointer;" src="https://bark-coding.vercel.app/src/projecttoolbar/pause.svg">
          <img class="projectToolbarButton" style="cursor:pointer;" src="https://bark-coding.vercel.app/src/projecttoolbar/stopped.svg">
          <img class="projectToolbarButton" src="https://bark-coding.vercel.app/src/projecttoolbar/maximize.svg" style="position: absolute; right: 0; cursor: pointer;">
        </div>
        <div id="stage-container"></div>
    </div>
    <div id="sprites" style="position: absolute; right: 0%; bottom: 0%; width: 480px; height: calc(100% - 440px);">the bark editor is not finished <b>yet</b>,
    please be patient.

    <!-- Toolbox Definition -->
    <div id="toolbox">
      <!-- this is loaded from a file now -->
  </div>

    <script>

      function start() {
        var workspace = Blockly.inject('blocklyDiv', {
          toolbox: document.getElementById('toolbox'),
          horizontalLayout: true,
          toolboxPosition: 'end',
          renderer: 'zelos',
        });

        workspace.addChangeListener(updateStage);
      }

      function updateStage(event) {
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        document.getElementById('generated-code').textContent = code; // Display generated code
        eval(code); // Evaluate generated code
      }

      Blockly.Blocks['change_costume'] = { // Changes costume to a specific one
        init: function() {
          this.jsonInit({
            "type": "change_costume",
            "message0": "switch costume",
            "previousStatement": null,
            "nextStatement": null,
            "colour": 260,
            "tooltip": "",
            "helpUrl": ""
          });
        }
      };
      
            Blockly.Blocks['next_costume'] = { // Moved this block outside the previous block
        init: function() {
          this.jsonInit({
            "type": "next_costume",
            "message0": "next costume",
            "previousStatement": null,
            "nextStatement": null,
            "colour": 260,
            "tooltip": "",
            "helpUrl": ""
          });
        }
      };
      
      Blockly.Blocks['change_stage_bg'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("change stage bg to")
        .appendField(new Blockly.FieldColour("#ff0000"), "NAME");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(260);
 this.setTooltip("");
 this.setHelpUrl("");
  }
};

      
      Blockly.Blocks['movement_move'] = { // Moves sprite
        init: function() {
          this.jsonInit({
            "type": "movement_move",
            "message0": "move",
            "previousStatement": null,
            "nextStatement": null,
            "colour": 230,
            "tooltip": "",
            "helpUrl": ""
          });
        }
      };

            Blockly.Blocks['movement_moveback'] = { // Moves sprite back
        init: function() {
          this.jsonInit({
            "type": "movement_moveback",
            "message0": "move backwards",
            "previousStatement": null,
            "nextStatement": null,
            "colour": 230,
            "tooltip": "",
            "helpUrl": ""
          });
        }
      };
      
      Blockly.Blocks['onstart'] = {
        init: function() {
          this.appendStatementInput("start")
              .setCheck(null)
              .appendField("when")
              .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, { alt: "*", flipRtl: "FALSE" }))
              .appendField("clicked");
          this.setColour(20);
       this.setTooltip("");
       this.setHelpUrl("");
        }
      };
      
      Blockly.Blocks['pointdir'] = {
        init: function() {
          this.appendValueInput("NAME")
              .setCheck(null)
              .appendField("point in direction")
              .appendField(new Blockly.FieldAngle(90), "NAME");
          this.setPreviousStatement(true, null);
          this.setNextStatement(true, null);
          this.setColour(230);
       this.setTooltip("");
       this.setHelpUrl("");
        }
      };
      
      Blockly.Blocks['javascript_block'] = {
  init: function() {
    this.appendValueInput("js")
        .setCheck("String")
        .appendField("javascript");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(315);
    this.setTooltip("Runs Vanilla Javascript.");
    this.setHelpUrl("");
  }
};

      javascript.javascriptGenerator.forBlock['onstart'] = function(block, generator) {
        return "alert('green flag was clicked!');";
      };
      javascript.javascriptGenerator.forBlock['movement_move'] = function(block, generator) {
        return "basicMove()";
      };
      javascript.javascriptGenerator.forBlock['movement_moveback'] = function(block, generator) {
        return "basicMoveBack()";
      };
      
      javascriptGenerator.forBlock['javascript_block'] = function(block, generator) {
  // Generate JavaScript code.
  const jsCode = generator.valueToCode(block, 'js', Blockly.JavaScript.ORDER_ATOMIC);

  // Return the generated code.
  return jsCode;
};
      
      Blockly.Blocks['change_stage_bg'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("Change stage background color to");
    this.appendDummyInput()
        .appendField(new Blockly.FieldColour("#ffffff"), "NAME");
    this.setPreviousStatement(true, null);
    this.setNextStatement(true, null);
    this.setColour(230);
    this.setTooltip("");
    this.setHelpUrl("");
  },

  // This function will be called whenever the block value changes
  onchange: function(event) {
    if (!this.workspace || this.workspace.isDragging() || event.type != Blockly.Events.BLOCK_CHANGE) {
      return;  // Don't change the stage while dragging blocks or on events other than block changes
    }
    if (event.blockId === this.id && event.name === "NAME") {
      var color = this.getFieldValue('NAME');
      // Call a JavaScript function in your p5.js sketch to change the background color
      changeBackgroundColor(color);
    }
  }
};

    </script>
    <script>
          /* @mnsderp for the data saving scripts */

          // Function to toggle dark mode
          function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            // Save dark mode state to local storage
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
          }
          $(document).ready(function(){
            $.ajax({
                type: "GET",
                url: "https://bark-coding.vercel.app/editor_new/toolbox.xml",
                dataType: "xml",
                success: function(xml){
                    // Parse the XML and insert it into the HTML
                    var xmlString = new XMLSerializer().serializeToString(xml);
                    $('#toolbox').html(xmlString);
                },
                error: function(xhr, status, error){
                    console.error("Error fetching XML:", error);
                }
            });
        });
        
          // Function to initialize dark mode based on local storage
          function initializeDarkMode() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            const body = document.body;
            if (isDarkMode) {
              body.classList.add('dark-mode');
            } else {
              body.classList.remove('dark-mode');
            }
          }
        
          // Attach event listener to dark mode toggle button
          const darkModeToggle = document.getElementById('darkModeToggle');
          darkModeToggle.addEventListener('click', toggleDarkMode);
        
          // Initialize dark mode when the page loads
          window.addEventListener('load', initializeDarkMode);

          function openexternalproject() {
            window.showOpenFilePicker();
            alert("bark doesn't support uploading projects yet.");
          }

          // https://gist.github.com/tiodot/4978b36aae431b79fa3ea9ba6800a90a
          function downloadproject(fileName) {
            fetch("https://raw.githubusercontent.com/Mariocraft987/bark.github.io/main/editor_new/project_example.txt", { method: 'get', mode: 'no-cors', referrerPolicy: 'no-referrer' })
              .then(res => res.blob())
              .then(res => {
                const aElement = document.createElement('a');
                aElement.setAttribute('download', fileName);
                const href = URL.createObjectURL(res);
                aElement.href = href;
                aElement.setAttribute('target', '_blank');
                aElement.click();
                URL.revokeObjectURL(href);
              });
          };

          function run_code() {
            eval(Blockly.JavaScript.workspaceToCode(Blockly.getMainWorkspace()));
          }

          // Script from Stack Overflow
          var openFile = function(file) {
          var input = file.target;
          var reader = new FileReader();
            reader.onload = function(){
          var dataURL = reader.result;
          var output = document.getElementById('costume');
          output.src = dataURL;
  };
  reader.readAsDataURL(input.files[0]);
};
    </script>
  </body>
  <script src="https://bark-coding.vercel.app/index.js"></script>
</html>
